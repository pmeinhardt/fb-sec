<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>clueless-fb</title>
  <style>
    body { font: normal 12px/18px Helvetica, Arial, sans-serif; }

    .hidden { display: none; }

    .draggable { cursor: move; }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>clueless-fb</h1>
    <div id="spinner">
      <!-- css-animated activity indicator -->
    </div>
    <div id="results" class="hidden">
      <p><a id="bookmarklet" href="#" class="draggable">cl-fb</a></p>
      <p><input id="pubkey" type="text"></p>
    </div>
    <div id="instructions">
      <ol>
        <li>Drag the link to your bookmarks bar</li>
        <li>Then copy the pubkey…</li>
      </ol>
    </div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="/lib/jsbn.js"></script>
  <script src="/lib/jsbn2.js"></script>
  <script src="/lib/prng4.js"></script>
  <script src="/lib/rng.js"></script>
  <script src="/lib/rsa.js"></script>
  <script src="/lib/rsa2.js"></script>
  <script>
    $(function() {
      // Generate a public-private key pair used for asymmetric enryption.
      var keygen = function(options) {
        var key = new RSAKey();
        key.generate(options.bits, options.e);
        return key;
      };

      // Export the public key data from a generated key.
      var pubkey = function(key) {
        var pub = [
          key.n.toString(16),
          key.e.toString(16)
        ].join('|');
        return pub;
      };

      // Export the private key data from a generated key.
      var privkey = function(key) {
        var priv = [
          key.n.toString(16),
          key.e.toString(16),
          key.d.toString(16)
        ].join('|');
        return priv;
      };

      // Encode a string of JavaScript for use as a bookmarklet. See:
      // http://daringfireball.net/2007/03/javascript_bookmarklet_builder
      var bookmarkify = function(script) {
        var bookmark, lines, line, i;
        lines = script.split('\n');
        bookmark = [];
        for (i = 0; i < lines.length; i++) {
          line = lines[i];
          line = line.replace(/\s+\/\/.*$/, ''); // strip comments
          line = line.replace(/\t/g, ' ');       // tabs to one space
          line = line.replace(/ {2,}/g, ' ');    // space runs to one space
          line = line.replace(/^ +/, '');        // trim leading whitespace
          line = line.replace(/ +$/, '');        // trim trailing whitespace
          bookmark.push(line);
        }
        return 'javascript:' + bookmark.join('');
      };

      // Build a fresh new bookmarklet.
      $.get('/clueless-fb.js', function(data) {
        var source, bits, key, $spinner, $results, $a, $pubkey;

        // Use a shorter key size for local development.
        bits = (window.location.hostname === 'localhost')? 1024 : 2048;

        // Generate a secure public-private key pair. Refer to the README for
        // for documentation on the chosen key generation parameter values.
        key = keygen({
          bits: bits, // 2048 recommended
          e: '10001'  // hex ~> 65537
        });

        // Fill out the bookmarklet template.
        source = data.replace('<private-key>', privkey(key));

        // Create a bookmark link, which can be dragged to the bookmarks bar.
        $a = $('#bookmarklet');
        $a.attr({href: bookmarkify(source)});

        // Present the public key, for copy-pasting into place…
        $pubkey = $('#pubkey');
        $pubkey.val(pubkey(key));
        $pubkey.on('click', function() { this.select(); });

        // Done. Show the results, hide the spinner.
        $spinner = $('#spinner').addClass('hidden');
        $results = $('#results').removeClass('hidden');
      });
    });
  </script>
</body>
</html>
